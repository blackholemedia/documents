
Table of Contents
=================

   * [Zookeeper](#zookeeper)
      * [参考引用](#参考引用)
      * [定义](#定义)
         * [分布式系统的问题](#分布式系统的问题)
         * [文件系统(znode)](#文件系统znode)
         * [监听通知机制](#监听通知机制)
      * [部署方式](#部署方式)
         * [单机部署](#单机部署)
         * [集群部署](#集群部署)
      * [Zookeeper能做什么](#zookeeper能做什么)
         * [分布式应用配置管理](#分布式应用配置管理)
         * [统一命名服务](#统一命名服务)
         * [状态同步(分布式锁)](#状态同步分布式锁)
         * [集群管理](#集群管理)

Created by ALTA

=================

# Zookeeper  

<font color=#008000>绿色字体</font>代表个人的思考理解，<font color=Yellow>黄色字体</font>代表阅读理解过程中的疑问，<font color=Red>红色字体</font>代表关键重要信息，<u>下划线</u>代表次关键重要信息，`阴影`或 *一般斜体* 均表示引用或强调 

```python
# ---------------------------------- 输出结果
```

## 参考引用  

本文引用及参考自下列文章/网站， 版权归属原作者所有：

1. [Zookeeper入门看这篇就够了](https://blog.csdn.net/java_66666/article/details/81015302)
2. [原创ZooKeeper入门实战教程（一）-介绍与核心概念](https://blog.csdn.net/liyiming2017/article/details/83035157)
3. [zookeeper到底是干嘛的](<https://www.cnblogs.com/ultranms/p/9585191.html>)
4. [Zookeeper工作原理（详细）](<https://www.cnblogs.com/raphael5200/p/5285583.html>)

## 定义  

ZooKeeper最为主要的使用场景，是作为分布式系统的分布式协同服务，主要是用来解决分布式应用中经常遇到的一些数据管理问题，如：统一命名服务、状态同步服务、集群管理、分布式应用配置项的管理等。上面的解释有点抽象，简单来说zookeeper=文件系统+监听通知机制  

### 分布式系统的问题  

<font color=Red>数据一致性(拜占庭问题)</font>

### 文件系统(znode)  

Zookeeper维护一个类似文件系统的数据结构，每个子目录项如 NameService 都被称作为 znode(目录节点)  

<div align="center"> <img src="https://blackholemedia.github.io/documents/statics/zk_filesystem.png" width="400px"> </div><br>

### 监听通知机制  

客户端注册监听它关心的目录节点，当目录节点发生变化（数据改变、被删除、子目录节点增加删除）时，zookeeper会通知客户端  

## 部署方式  

### 单机部署  

left blank  

### 集群部署  

left blank

## Zookeeper能做什么  

zookeeper功能非常强大，可以实现诸如分布式应用配置管理、统一命名服务、状态同步服务、集群管理等功能  

### 分布式应用配置管理  

假设我们的程序是分布式部署在多台机器上，如果我们要改变程序的配置文件，需要逐台机器去修改，非常麻烦，现在把这些配置全部放到zookeeper上去，保存在 zookeeper 的某个目录节点中，然后所有相关应用程序对这个目录节点进行监听，一旦配置信息发生变化，每个应用程序就会收到 zookeeper 的通知，然后从 zookeeper 获取新的配置信息应用到系统中。在我们的应用中除了代码外，还有一些就是各种配置。比如数据库连接等。一般我们都是使用配置文件的方式，在代码中引入这些配置文件。但是当我们只有一种配置，只有一台服务器，并且不经常修改的时候，使用配置文件是一个很好的做法，但是如果我们配置非常多，有很多服务器都需要这个配置，而且还可能是动态的话使用配置文件就不是个好主意了。这个时候往往需要寻找一种集中管理配置的方法，我们在这个集中的地方修改了配置，所有对这个配置感兴趣的都可以获得变更。比如我们可以把配置放在数据库里，然后所有需要配置的服务都去这个数据库读取配置。但是，因为很多服务的正常运行都非常依赖这个配置，所以需要这个集中提供配置服务的服务具备很高的可靠性。一般我们可以用一个集群来提供这个配置服务，但是用集群提升可靠性，那如何保证配置在集群中的一致性呢？ 这个时候就需要使用一种实现了一致性协议的服务了。Zookeeper就是这种服务，它使用Zab这种一致性协议来提供一致性。现在有很多开源项目使用Zookeeper来维护配置，比如在HBase中，客户端就是连接一个Zookeeper，获得必要的HBase集群的配置信息，然后才可以进一步操作。还有在开源的消息队列Kafka中，也使用Zookeeper来维护broker的信息。在Alibaba开源的SOA框架Dubbo中也广泛的使用Zookeeper管理一些配置来实现服务治理。  

<div align="center"> <img src="https://blackholemedia.github.io/documents/statics/zk_listen.png" width="400px"> </div><br>

### 统一命名服务  

比如为了通过网络访问一个系统，我们得知道对方的IP地址，但是IP地址对人非常不友好，这个时候我们就需要使用域名来访问。但是计算机是不能识别域名的。于是我们有了hosts/DNS这个东西。我们只需要访问一个大家熟知的(known)的点，它就会告诉你这个域名对应的IP是什么。在我们的应用中也会存在很多这类问题，特别是在我们的服务特别多的时候，如果我们在本地保存服务的地址的时候将非常不方便，但是如果我们只需要访问一个大家都熟知的访问点，这里提供统一的入口，那么维护起来将方便得多了。

### 状态同步(分布式锁)  

比如在一个分布式环境中，为了提高可靠性，我们的集群的每台服务器上都部署着同样的服务。但是，一件事情如果集群中的每个服务器都进行的话，那相互之间就要协调，编程起来将非常复杂。而如果我们只让一个服务进行操作，那又存在单点。通常还有一种做法就是使用分布式锁，在某个时刻只让一个服务去干活，当这台服务出问题的时候锁释放，立即fail over到另外的服务。这在很多分布式系统中都是这么做，这种设计有一个更好听的名字叫Leader Election(leader选举)(<font color=green>也就是说选举针对的是zk管理的分布式系统，不是针对zk集群本身</font>)。比如HBase的Master就是采用这种机制。但要注意的是分布式锁跟同一个进程的锁还是有区别的，所以使用的时候要比同一个进程里的锁更谨慎的使用  

### 集群管理  

在分布式的集群中，经常会由于各种原因，比如硬件故障，软件故障，网络问题，有些节点会进进出出。有新的节点加入进来，也有老的节点退出集群。这个时候，集群中其他机器需要感知到这种变化，然后根据这种变化做出对应的决策。比如我们是一个分布式存储系统，有一个中央控制节点负责存储的分配，当有新的存储进来的时候我们要根据现在集群目前的状态来分配存储节点。这个时候我们就需要动态感知到集群目前的状态。还有，比如一个分布式的SOA架构中，服务是一个集群提供的，当消费者访问某个服务时，就需要采用某种机制发现现在有哪些节点可以提供该服务(这也称之为服务发现，比如Alibaba开源的SOA框架Dubbo就采用了Zookeeper作为服务发现的底层机制)。还有开源的Kafka队列就采用了Zookeeper作为Cosnumer的上下线管理